<!DOCTYPE html>
<html lang="fr">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Cesi Eats - Mon profil</title>

    <link rel="apple-touch-icon" sizes="180x180" href="/img/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon/favicon-16x16.png">
    <link rel="manifest" href="/img/favicon/site.webmanifest">

    <!-- Custom styles for this template -->
    <link href="css/sb-admin-2.min.css" rel="stylesheet">

    <!-- Custom styles for this page -->
    <link href="vendor/datatables/dataTables.bootstrap4.min.css" rel="stylesheet">

</head>

<body id="page-top">

    <!-- Page Wrapper -->
    <div id="wrapper">

        <div id="sidebar"></div>
        <!-- End of Sidebar -->

        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">

            <!-- Main Content -->
            <div id="content">

                <!-- Topbar -->
                <div id="topbar"></div>

                <h1 class="h3 mx-4 mb-2 text-gray-800">Vos informations</h1>

                <form class="user m-4">
                    <div class="form-group row">
                        <div class="col-sm-6 mb-3 mb-sm-0">
                            <input type="text" class="form-control form-control-user" id="name"
                                placeholder="Nom">
                        </div>
                        <div class="col-sm-6">
                            <input type="text" class="form-control form-control-user" id="lastname"
                                placeholder="Prénom">
                        </div>
                    </div>

                    <div class="form-group">
                        <input type="email" class="form-control form-control-user" id="email"
                            placeholder="Adresse mail">
                    </div>

                    <div class="form-group row">
                        <div class="col-sm-6 mb-3 mb-sm-0">
                            <input type="text" class="form-control form-control-user" id="pseudo"
                            placeholder="Pseudonyme">
                        </div>
                        <div class="col-sm-6">
                            <input type="phone" class="form-control form-control-user"
                            id="phone" placeholder="Numéro de téléphone">
                        </div>
                    </div>

                    <div class="form-group">
                        <input type="text" class="form-control form-control-user" id="address"
                            placeholder="Adresse postale">
                    </div>
                    <div class="form-group row">
                        <div class="col-sm-6 mb-3 mb-sm-0">
                            <input type="password" class="form-control form-control-user"
                                id="new_password" placeholder="Nouveau mot de passe">
                        </div>
                        <div class="col-sm-6">
                            <input type="password" class="form-control form-control-user"
                                id="repeat_new_password" placeholder="Confirmation du nouveau mot de passe">
                        </div>
                    </div>

                    <div class="form-group row">
                        <div class="col-sm-6 mb-3 mb-sm-0">
                            <input type="text" class="form-control form-control-user" disabled
                                id="referral" placeholder=" Code de parrainage">
                        </div>
                        <div class="col-sm-6">
                                <select class="custom-select custom-select-sm form-control form-control-sm" disabled id="role-select">
                                    <option selected value="client">Client</option>
                                    <option value="deliverer">Livreur</option>
                                    <option value="restaurant">Restaurateur</option>
                                    <option value="commercial">Commercial</option>
                                    <option value="tech">Technique</option>
                                    <option value="dev">Développeur</option>
                                  </select>
                        </div>
                    </div>

                    <div class="card bg-danger text-white shadow mt-3 d-none" id="password-repeat-error">
                        <div class="card-body">
                            Erreur d'inscription
                            <div class="text-white-50 small">Les mots de passes ne sont pas similaires</div>
                        </div>
                    </div>

                    <div class="card bg-success text-white shadow mt-3 d-none" id="account-update-creation">
                        <div class="card-body">
                            Mise à jour de votre compte avec succès
                            <div class="text-white-50 small">Vos nouvelles informations ont bien été mises à jour !</a></div>
                        </div>
                    </div>

                    <div class="card bg-danger text-white shadow mt-3 d-none" id="account-update-error">
                        <div class="card-body">
                            Erreur de mise à jour
                            <div class="text-white-50 small">Impossible de mettre à jour votre compte, veuillez vous reconnecter et réessayer</a></div>
                        </div>
                    </div>

                    <div class="form-group row w-50 mt-4" style="margin-left: 25%;">
                        <div class="col-sm-6 mb-3 mb-sm-0">
                            <a href="javascript:editAccount()" class="btn btn-primary btn-user btn-block">
                                Enregistrer mes modifications
                            </a>
                        </div>
                        <div class="col-sm-6">
                            <a href="#" class="btn btn-danger btn-user btn-block" data-toggle="modal" data-target="#deleteModal">
                                Supprimer mon compte
                            </a>  
                        </div>
                    </div>

                </form>

            </div>
            <!-- End of Main Content -->

            <!-- Footer -->
            <div id="copyright"></div>
            <!-- End of Footer -->

        </div>
        <!-- End of Content Wrapper -->

    </div>
    <!-- End of Page Wrapper -->

    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
        <i class="fas fa-angle-up"></i>
    </a>

    <!-- Logout Modal-->
    <div id="logout_modal"></div>
    <div id="delete_modal"></div>

    <!-- Bootstrap core JavaScript-->
    <script src="vendor/jquery/jquery.min.js"></script>
    <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="js/sb-admin-2.min.js"></script>

    <!-- Page level plugins -->
    <script src="vendor/datatables/jquery.dataTables.min.js"></script>
    <script src="vendor/datatables/dataTables.bootstrap4.min.js"></script>

    <!-- Page level custom scripts -->
    <script src="js/demo/datatables-demo.js"></script>

    <script>
        $(function(){
            $("#sidebar").load("components/sidebar.html");
            $("#topbar").load("components/topbar.html");
            $("#copyright").load("components/footer.html");
            $("#logout_modal").load("components/logout_modal.html");
            $("#delete_modal").load("components/delete_modal.html")
            $(".current-year").html(new Date().getFullYear());

            editProfileData();
        });

        async function editProfileData(){
            const response = await fetch('/accounts/current/user');
            const data = await response.json();

            $("#name").val(data[0].name)
            $("#lastname").val(data[0].lastname)
            $("#email").val(data[0].mail)
            $("#pseudo").val(data[0].pseudo)
            $("#phone").val(data[0].phone)
            $("#address").val(data[0].address)
            $("#role-select").val(data[0].role)
            $("#referral").val(data[0].referralCode || "")
        }

        function editAccount(){
            if ($("#new_password").val() !== $("#repeat_new_password").val()){
                $("#password-repeat-error").removeClass("d-none");
                window.setInterval(()=>$("#password-repeat-error").addClass("d-none"),5000);
            }else{
                let formData = {
                    name : $("#name").val(),
                    lastname : $("#lastname").val(),
                    pseudo : $("#email").val(),
                    mail : $("#pseudo").val(),
                    phone : $("#phone").val(),
                    address : $("#address").val(),
                    password : $("#new_password").val(),
                };

                console.log(formData);

                fetch("/accounts/",
                {
                    body: JSON.stringify(formData),
                    method: "PUT",
                    headers: {'Content-Type': 'application/json'}
                }).then(function(response) {
                    if (response.status >= 200 && response.status < 300){
                        // Redirect to login page
                        $("#account-update-creation").removeClass("d-none");
                    }else{
                        $("#account-update-error").removeClass("d-none");
                        window.setInterval(()=>$("#account-update-error").addClass("d-none"),3000);
                    }
                });
            }
        }
    </script>
</body>

</html>